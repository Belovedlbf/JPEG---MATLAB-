# JPEG 类图像压缩系统 - MATLAB 实现

## 项目简介
本项目实现了一个基于 MATLAB 的 JPEG 风格图像压缩系统，采用 DCT 变换、量化、游程编码和熵编码技术，并包含自定义二进制容器格式 `.lbf` 的读写功能。系统完整实现了从图像压缩到解压重建的全流程。

---

## 核心特性

- **颜色空间转换**: RGB 到 YCbCr 转换
- **DCT 变换**: 基于 8×8 块的离散余弦变换 (`dctmtx`)
- **自适应量化**: 支持亮度/色度量化表，可按质量参数调整
- **压缩编码**: ZigZag 扫描、EOB 标记、游程编码 (RLE)
- **熵编码接口**: 集成香农-法诺 (Shannon-Fano) 编码
- **自定义容器**: 二进制格式 `.lbf` 文件的读写
- **图像重建**: 完整的解压流程，恢复为 RGB 图像
- **可视化工具**: 支持压缩结果展示和图像保存

---

## 文件结构

### 核心模块
| 文件 | 功能描述 |
|------|----------|
| `mainJPEG.m` | 主交互脚本：选择图像、设置质量、执行完整压缩/解压流程 |
| `RGB2YCBCR.m` | RGB 转 YCbCr 颜色空间，执行 DCT 变换和量化 |
| `Compress.m` | 量化块 ZigZag 扫描，生成压缩向量和 EOB 标记 |
| `Decompress.m` | 从压缩流解析数据，执行反量化、IDCT 变换 |
| `YCBCR2RGB.m` | 三通道解压后转换回 RGB 格式 |

### 容器操作
| 文件 | 功能描述 |
|------|----------|
| `write_lbf.m` | 将压缩数据写入 `.lbf` 二进制容器 |
| `read_lbf.m` | 从 `.lbf` 文件读取并解析压缩数据 |

### 编码工具
| 文件 | 功能描述 |
|------|----------|
| `rle.m`, `rld.m` | 游程编码与解码 |
| `shannon_fano.m` | 香农-法诺熵编码实现 |
| `imdisplay.m` | 优化的图像显示函数 |

### 辅助脚本
| 文件 | 功能描述 |
|------|----------|
| `decompress_from_mat.m` | 示例：从 `.lbf` 或 `.mat` 文件解压恢复图像 |

---

## 系统要求

### 必需环境
- **MATLAB** (已测试版本: R2016 ~ R2024)

### 必需工具箱
- Image Processing Toolbox (用于 `blockproc`, `im2col`, `col2im`)
- Signal Processing Toolbox (用于 `dctmtx`)

### 兼容性说明
- **GNU Octave**: 不直接兼容，需修改 `blockproc`, `dctmtx` 等相关函数
- **依赖项**: 所有必需脚本均包含在项目中，无需第三方库

---

## 快速入门指南

### 方法一：交互式运行
```matlab
% 运行主脚本，按提示操作
mainJPEG
```
**执行流程:**
1. 选择输入图像文件 (支持格式: BMP, JPG, PNG 等)
2. 输入压缩质量 (0-100，推荐 50-90)
3. 系统自动:
   - 压缩图像，保存为 `test2_compressed.lbf` (失败时回退为 `.mat`)
   - 解压恢复图像
   - 显示对比结果
   - 保存恢复图像为 `test2_recovered.bmp`

### 方法二：手动解压
```matlab
% 从 .lbf 文件手动解压
S = read_lbf('test2_compressed.lbf');
recovered = YCBCR2RGB(S.compress_image_Y, S.compress_image_CB, S.compress_image_CR);
imwrite(recovered, 'recovered_manual.bmp');
```

---

## `.lbf` 容器格式规范

### 文件头 (Header)
| 字段 | 大小 | 描述 |
|------|------|------|
| 标识符 | 3 字节 | ASCII "LBF" |
| 版本号 | 4 字节 | int32 (当前版本: 1) |
| 通道数 | 4 字节 | int32 (通常为 3: Y, Cb, Cr) |

### 通道数据 (每个通道重复)
| 字段 | 大小 | 描述 |
|------|------|------|
| 通道ID | 4 字节 | int32 (1=Y, 2=Cb, 3=Cr) |
| 图像行数 | 4 字节 | int32 |
| 图像列数 | 4 字节 | int32 |
| 块数量 | 4 字节 | int32 (8×8 分块数) |
| 压缩流大小 | 4 字节 | int32 |
| EOB 标记 | 4 字节 | int32 |
| RLE 向量长度 | 4 字节 | int32 |
| RLE 向量 | 变长 | int32[rlen] |
| 量化表标志 | 1 字节 | uint8 (0=无, 1=有) |
| 量化表 | 128 字节 | uint16[64] (仅当 qflag=1) |

---

## 故障排除

### 常见问题及解决方案

| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 图像显示过暗/颜色异常 | double 图像显示时被错误归一化 | 使用 `imdisplay` 函数，对整型图像直接显示 |
| `write_lbf` 写入失败 | 目录权限不足或结构体字段缺失 | 检查写入权限，确认结构体包含 `r`, `size`, `numblocks`, `channel` |
| `read_lbf` 读取失败 | 文件损坏或非 `.lbf` 格式 | 确认文件由 `write_lbf` 生成且未损坏 |
| 函数未定义错误 | 缺少工具箱 | 安装 Image Processing Toolbox 和 Signal Processing Toolbox |
| 压缩流查看 | - | 在 `mainJPEG` 中检查 `S.compress_image_Y.r` 等向量 |

### 调试建议
1. **逐步执行**: 在 `mainJPEG.m` 中设置断点，逐步检查压缩流程
2. **数据验证**: 比较压缩前后的图像数据差异
3. **格式检查**: 使用十六进制编辑器查看 `.lbf` 文件结构
4. **内存监控**: 处理大图像时注意内存使用情况

---

## 项目扩展

### 可能的改进方向
1. **性能优化**: 实现更高效的 DCT 算法
2. **编码增强**: 集成霍夫曼编码等其他熵编码方法
3. **格式扩展**: 支持更多图像格式和颜色模式
4. **GUI 界面**: 开发图形用户界面便于操作
5. **批量处理**: 增加批量压缩/解压功能

### 学术应用
- 图像压缩算法教学
- DCT 变换原理演示
- 无损/有损压缩比较研究
- 自定义文件格式设计示例

---

## 许可证与声明

本项目为教育演示用途，遵循学术诚信原则。
建议用于学习图像压缩算法原理和 MATLAB 编程实践。

**注意**: 实际部署使用时请考虑性能优化和错误处理的完善。